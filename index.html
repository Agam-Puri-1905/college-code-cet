<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MHT-CET College Cutoff — Sign-in Required</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand: #e6403a;
      --brand-600:#d8352e;
      --brand-soft:#fff1f0;
      --ink:#111827;
      --muted:#6b7280;
      --bg:#f7f8fb;
      --card:#ffffff;
      --stroke:#e5e7eb;
      --ring:#cfe2ff;
      --table-head:#24343a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--stroke);backdrop-filter: blur(8px);}
    .topbar-inner{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand-badge{display:flex;align-items:center;gap:12px;font-weight:700;color:#1f2937}
    .badge{width:34px;height:34px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center;font-family:Poppins,Inter,sans-serif;font-weight:600;letter-spacing:0.2px;box-shadow:0 6px 20px rgba(230,64,58,.25)}
    .site-link{margin-left:auto;display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;background:var(--brand-soft);color:var(--brand);text-decoration:none;font-weight:600;border:1px solid #ffd6d3}
    .site-link:hover{background:#ffe6e4}

    /* Shell & cards */
    .wrap{max-width:1200px;margin:30px auto;padding:0 20px 40px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 20px 60px rgba(16,24,40,.06);padding:26px;margin-bottom:18px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){ .grid-2{grid-template-columns:1fr} }

    h1{margin:0 0 18px 0;font-family:Poppins,Inter,sans-serif;font-size:26px;font-weight:700;letter-spacing:.2px}
    label{font-weight:600;color:#374151;display:block;margin:10px 0 8px}
    input[type="text"],input[type="email"],input[type="tel"],input[type="number"],select{
      width:100%;padding:13px 14px;border:1px solid var(--stroke);background:#fff;border-radius:10px;font-size:15px;color:#1f2937;outline:none;transition:border .2s,box-shadow .2s,background .2s
    }
    input::placeholder{color:#9ca3af}
    input:focus,select:focus{border-color:#bcd3ff;box-shadow:0 0 0 4px var(--ring);background:#fff}
    .help{font-size:12.5px;color:var(--muted);margin-top:6px}
    .error{color:#dc2626;font-size:13px;margin-top:6px}

    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:10px;font-weight:700;transition:.2s transform,.2s box-shadow,.2s background}
    .btn-primary{background:var(--brand);color:#fff;box-shadow:0 10px 18px rgba(230,64,58,.25)}
    .btn-primary:hover{background:var(--brand-600);transform:translateY(-1px)}
    .btn-ghost{background:transparent;color:#0d6efd}
    .btn[disabled]{opacity:.7;cursor:not-allowed}

    .header-row{display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap}
    .greeting{border:1px dashed #fecaca;background:var(--brand-soft);color:#b91c1c;padding:12px 14px;border-radius:10px;margin:10px 0 16px;font-weight:600}
    .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* College viewer (white card look) */
    .college-panel{padding:18px;border-radius:12px;background:var(--card);border:1px solid var(--stroke);color:var(--ink)}
    .controls-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    .select-simple{background:#fff;border-radius:8px;padding:10px 12px;border:1px solid var(--stroke);min-width:220px}
    .table-wrap{overflow:auto;border-radius:8px;background:#fff;padding:12px;margin-top:6px;border:1px solid var(--stroke)}
    table{width:100%;border-collapse:collapse;font-size:13px;color:#111827}
    th,td{padding:10px 8px;text-align:left;white-space:nowrap;border-bottom:1px solid #f1f5f9}
    th{background:#fafafa;position:sticky;top:0;z-index:2;font-weight:700;color:#374151}
    tr:nth-child(even) td{background:#fbfbfb}
    .muted{color:var(--muted);font-size:12px}
    .footer-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted)}
    @media (max-width:900px){ .select-simple{min-width:160px} }

    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-badge">
        <div class="badge">CS</div>
        <div>MHT CET Tools</div>
      </div>
      <a class="site-link" href="#" onclick="return false;">College Simplified</a>
    </div>
  </header>

  <main class="wrap">

    <!-- REQUIRED SIGN-IN FORM -->
    <section id="detailsSection" class="card">
      <h1>Enter Student Details (Required)</h1>
      <form id="detailsForm" novalidate>
        <div class="grid-2">
          <div>
            <label for="studentName">Full Name</label>
            <input id="studentName" type="text" placeholder="e.g., Agam Puri" />
            <div id="errName" class="error"></div>
          </div>
          <div>
            <label for="studentEmail">Email</label>
            <input id="studentEmail" type="email" placeholder="e.g., name@example.com" />
            <div id="errEmail" class="error"></div>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="studentMobile">Mobile Number</label>
            <input id="studentMobile" type="tel" inputmode="numeric" maxlength="10" placeholder="10-digit Indian mobile" />
            <div class="help">We’ll use this to share updates.</div>
            <div id="errMobile" class="error"></div>
          </div>
          <div>
            <label for="studentState">State</label>
            <select id="studentState">
              <option value="">Select State</option>
            </select>
            <div id="errState" class="error"></div>
          </div>
        </div>

        <div>
          <label for="studentCity">City</label>
          <input id="studentCity" type="text" placeholder="e.g., Pune" />
          <div id="errCity" class="error"></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <button id="saveContinueBtn" class="btn btn-primary" type="submit">Save & Continue</button>
          <span class="help">By saving, your details are stored locally for convenience.</span>
        </div>
      </form>
    </section>

    <!-- COLLEGE VIEWER: hidden until user saves details -->
    <section id="collegeCard" class="card college-panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <div>
          <h1 style="margin:0;font-size:18px">MHT-CET 2025 College Cutoff</h1>
          <div class="small" style="margin-top:6px">Select college and seat type to filter cutoffs</div>
        </div>

        <div style="display:flex;gap:10px;align-items:center;">
          <div id="signedAs" class="small" style="display:none;"></div>
          <button id="editDetailsBtn" class="btn btn-ghost" style="display:none">Edit details</button>
        </div>
      </div>

      <div class="controls-row" style="margin-top:14px;">
        <select id="collegeSelect" class="select-simple" aria-label="College">
          <option value="">-- Select College (All) --</option>
        </select>

        <select id="seatSelect" class="select-simple" aria-label="Seat Type">
          <option value="">-- Select Seat Type (All) --</option>
        </select>

        <button id="resetBtn" class="btn btn-primary" style="background:#111;color:#fff;border-radius:8px;padding:10px 12px;">Reset</button>
      </div>

      <div class="table-wrap" role="region" aria-live="polite" style="margin-top:8px;">
        <table id="dataTable" role="table" aria-label="MHT-CET data">
          <thead>
            <tr>
              <th class="sortable" data-key="Institute">College Name ▲</th>
              <th class="sortable" data-key="Branch">Branch</th>
              <th class="sortable" data-key="Seat Type">Seat Type</th>
              <th class="sortable" data-key="Percentile">Percentile</th>
              <th class="sortable" data-key="Rank">Rank</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td class="muted">Loading data...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="footer-row">
        <div class="muted">Showing <span id="showingCount">0</span> of <span id="totalAll">0</span> rows</div>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="muted">Rows per page:</label>
          <select id="rowsPerPage" class="select-simple" style="min-width:80px">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="25" selected>25</option>
            <option value="30">30</option>
            <option value="50">50</option>
          </select>
        </div>
      </div>
    </section>

  </main>

<script>
/* ================= Sign-in gate ================= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyt4ySHVQ3i4qI6trhDqGkQuZTMbv6cYkSrr4bFi_yk0RoqjgVGuT1gN6ZW8-lipytYBw/exec"; // optional Apps Script URL for logging (leave empty to skip)
const LS_KEY = "studentDetails_v1";
const statesIN = [
  "Andhra Pradesh","Arunachal Pradesh","Assam","Bihar","Chhattisgarh","Goa","Gujarat",
  "Haryana","Himachal Pradesh","Jharkhand","Karnataka","Kerala","Madhya Pradesh","Maharashtra",
  "Manipur","Meghalaya","Mizoram","Nagaland","Odisha","Punjab","Rajasthan","Sikkim","Tamil Nadu",
  "Telangana","Tripura","Uttar Pradesh","Uttarakhand","West Bengal",
  "Andaman and Nicobar Islands","Chandigarh",
  "Dadra and Nagar Haveli and Daman and Diu","Delhi",
  "Jammu and Kashmir","Ladakh","Lakshadweep","Puducherry"
];

function saveDetailsLocal(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }
function getDetails(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch(e){ return null; } }

async function postToSheet(payload, source){
  if(!WEBAPP_URL) return;
  const body = JSON.stringify({ ...payload, source, ua:navigator.userAgent });
  try{ await fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', body }); }catch(e){ /* ignore */ }
}

function fillStates(){
  const sel = document.getElementById('studentState');
  sel.innerHTML = '<option value="">Select State</option>';
  statesIN.forEach(s=>{
    const o = document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
  });
}

function validateDetails(){
  const name   = document.getElementById('studentName').value.trim();
  const email  = document.getElementById('studentEmail').value.trim();
  const mobile = document.getElementById('studentMobile').value.trim();
  const state  = document.getElementById('studentState').value.trim();
  const city   = document.getElementById('studentCity').value.trim();

  ['errName','errEmail','errMobile','errState','errCity'].forEach(id=>document.getElementById(id).textContent='');

  let ok=true;
  if(!name){ document.getElementById('errName').textContent='Please enter your name.'; ok=false; }
  const emailOK=/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(email);
  if(!emailOK){ document.getElementById('errEmail').textContent='Please enter a valid email.'; ok=false; }
  const mobileOK=/^[6-9]\d{9}$/.test(mobile);
  if(!mobileOK){ document.getElementById('errMobile').textContent='Enter a valid 10-digit Indian mobile number.'; ok=false; }
  if(!state){ document.getElementById('errState').textContent='Select your state.'; ok=false; }
  if(!city){ document.getElementById('errCity').textContent='Enter your city.'; ok=false; }

  return ok ? { name, email, mobile, state, city } : null;
}

function showCollegeViewer(details){
  document.getElementById('detailsSection').style.display = 'none';
  document.getElementById('collegeCard').style.display = 'block';
  const signedAs = document.getElementById('signedAs');
  signedAs.textContent = `Signed in: ${details.name}`;
  signedAs.style.display = 'inline-block';
  document.getElementById('editDetailsBtn').style.display = 'inline-block';
  document.getElementById('collegeCard').scrollIntoView({behavior:'smooth'});
  // load data (if not already)
  loadData();
}

function showDetailsForm(prefill){
  document.getElementById('collegeCard').style.display = 'none';
  document.getElementById('detailsSection').style.display = 'block';
  if(prefill){
    document.getElementById('studentName').value   = prefill.name || '';
    document.getElementById('studentEmail').value  = prefill.email || '';
    document.getElementById('studentMobile').value = prefill.mobile || '';
    document.getElementById('studentState').value  = prefill.state || '';
    document.getElementById('studentCity').value   = prefill.city || '';
  }
}

/* ================= College viewer logic ================= */

const DATA_FILE = 'MHT-CET DATA TEST.json';
let rawData = [];
let filtered = [];
let sortKey = 'Percentile';
let sortDir = -1;

function escapeHtml(s){ return (s===null||s===undefined) ? '' : String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function normalizeRecord(r){
  return {
    'Institute': r.Institute || r['College Name'] || r['Institute '] || '',
    'Branch': r.Branch || r['Course'] || '',
    'Seat Type': r['Seat Type'] || r.seatType || r['SeatType'] || '',
    'Rank': Number(r.Rank ?? r.rank ?? 0) || 0,
    'Percentile': Number(r.Percentile ?? r.percentile ?? 0) || 0
  };
}

async function loadData(){
  try{
    const resp = await fetch(DATA_FILE, { cache:'no-store' });
    const json = await resp.json();
    const data = Array.isArray(json) ? json : (json["MHT-CET College Data"] || Object.values(json).find(v=>Array.isArray(v)) || json);
    rawData = Array.isArray(data) ? data.map(normalizeRecord) : [];
    initCollege();
  }catch(e){
    document.getElementById('tbody').innerHTML = `<tr><td class='muted'>Unable to load ${DATA_FILE}. Place it in the same folder and serve from same origin.</td></tr>`;
    console.error('loadData error', e);
  }
}

function initCollege(){
  populateCollegeSelect();
  populateSeatSelect();
  filtered = [...rawData];
  renderCollege();
}

function populateCollegeSelect(){
  const list = Array.from(new Set(rawData.map(d=>d.Institute).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const sel = document.getElementById('collegeSelect');
  sel.innerHTML = '<option value="">-- Select College (All) --</option>' + list.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
}

function populateSeatSelect(college = ""){
  let seats;
  if(!college){
    seats = Array.from(new Set(rawData.map(d=>d['Seat Type']).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  } else {
    seats = Array.from(new Set(rawData.filter(d=>d.Institute===college).map(d=>d['Seat Type']).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  }
  const sel = document.getElementById('seatSelect');
  sel.innerHTML = '<option value="">-- Select Seat Type (All) --</option>' + seats.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
  if(college && seats.length===0){
    sel.innerHTML = '<option value="">(No seat types for selected college)</option>';
    sel.disabled = true;
  } else sel.disabled = false;
}

function applyFilters(){
  const college = document.getElementById('collegeSelect').value.trim();
  const seat = document.getElementById('seatSelect').value.trim();
  filtered = rawData.filter(d=>{
    if(college && d.Institute !== college) return false;
    if(seat && d['Seat Type'] !== seat) return false;
    return true;
  });
  sortAndRender();
}

function sortAndRender(){
  if(sortKey){
    filtered.sort((a,b)=>{
      let A = a[sortKey] ?? '';
      let B = b[sortKey] ?? '';
      if(typeof A === 'string') A = A.toLowerCase();
      if(typeof B === 'string') B = B.toLowerCase();
      if(A < B) return -1*sortDir;
      if(A > B) return 1*sortDir;
      return 0;
    });
  }
  renderCollege();
}

function renderCollege(){
  const rowsPerPage = Number(document.getElementById('rowsPerPage').value) || 25;
  const toShow = filtered.slice(0, rowsPerPage);
  const tbody = document.getElementById('tbody');

  if(toShow.length === 0){
    tbody.innerHTML = '<tr><td class="muted" colspan="5">No results found.</td></tr>';
  } else {
    tbody.innerHTML = toShow.map(d=>{
      return `<tr>
        <td title="${escapeHtml(d.Institute)}">${escapeHtml(d.Institute)}</td>
        <td title="${escapeHtml(d.Branch)}">${escapeHtml(d.Branch)}</td>
        <td>${escapeHtml(d['Seat Type'])}</td>
        <td>${(typeof d.Percentile === 'number') ? d.Percentile.toFixed(6) : escapeHtml(d.Percentile)}</td>
        <td>${d.Rank}</td>
      </tr>`;
    }).join('');
  }

  document.getElementById('showingCount').textContent = Math.min(filtered.length, rowsPerPage);
  document.getElementById('totalAll').textContent = rawData.length;
}

/* ================= Wiring ================= */

document.addEventListener('DOMContentLoaded', ()=>{

  fillStates();

  // If details already saved, go straight to viewer (signed-in)
  const existing = getDetails();
  if(existing && existing.name && existing.email && existing.mobile && existing.state && existing.city){
    showCollegeViewer(existing);
  } else {
    // show details form (viewer hidden)
    showDetailsForm(existing || {});
  }

  // Save details submit: required to proceed
  const form = document.getElementById('detailsForm');
  const saveBtn = document.getElementById('saveContinueBtn');
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const data = validateDetails();
    if(!data) return;
    saveBtn.disabled = true; saveBtn.textContent = 'Saving...';
    try{
      await postToSheet(data, 'details');
    }catch(e){ /* ignore logging errors */ }
    saveDetailsLocal(data);
    showCollegeViewer(data);
    saveBtn.disabled = false; saveBtn.textContent = 'Save & Continue';
  });

  // Edit details button in college header
  document.getElementById('editDetailsBtn').addEventListener('click', ()=>{
    const det = getDetails() || {};
    document.getElementById('studentName').value   = det.name || '';
    document.getElementById('studentEmail').value  = det.email || '';
    document.getElementById('studentMobile').value = det.mobile || '';
    document.getElementById('studentState').value  = det.state || '';
    document.getElementById('studentCity').value   = det.city || '';
    showDetailsForm(det);
    document.getElementById('detailsSection').scrollIntoView({behavior:'smooth'});
  });

  // College selects & buttons
  document.getElementById('collegeSelect').addEventListener('change', ()=>{
    populateSeatSelect(document.getElementById('collegeSelect').value);
    document.getElementById('seatSelect').value = '';
    applyFilters();
  });

  document.getElementById('seatSelect').addEventListener('change', applyFilters);

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.getElementById('collegeSelect').value = '';
    populateSeatSelect('');
    document.getElementById('seatSelect').value = '';
    filtered = [...rawData];
    sortAndRender();
  });

  document.getElementById('rowsPerPage').addEventListener('change', renderCollege);

  // sortable headers
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(sortKey === key) sortDir *= -1;
      else { sortKey = key; sortDir = (key === 'Percentile' || key === 'Rank') ? -1 : 1; }
      document.querySelectorAll('th.sortable').forEach(h=>{
        h.textContent = h.dataset.key + (h.dataset.key === sortKey ? (sortDir>0 ? ' ▲' : ' ▼') : '');
      });
      sortAndRender();
    });
  });

});
</script>
</body>
</html>
